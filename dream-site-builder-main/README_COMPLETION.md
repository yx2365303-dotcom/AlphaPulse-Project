# ğŸ‰ ç½‘ç«™åŠŸèƒ½å®Œå–„å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ âœ…

**å®ç°å†…å®¹ï¼š**
- âœ… åˆ›å»º Supabase ç”¨æˆ·è¡¨ (`public.users`)
- âœ… åˆ›å»ºç”¨æˆ·æ´»åŠ¨æ—¥å¿—è¡¨ (`public.user_activity_logs`)
- âœ… è‡ªåŠ¨è§¦å‘å™¨ï¼ˆæ³¨å†Œæ—¶åŒæ­¥åˆ›å»ºç”¨æˆ·è®°å½•ï¼‰
- âœ… ç™»å½•éªŒè¯ï¼ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æ•°æ®åº“ä¸­ï¼‰
- âœ… æ´»åŠ¨æ—¥å¿—è®°å½•ï¼ˆç™»å½•ã€æ³¨å†Œã€é€€å‡ºï¼‰
- âœ… è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `src/hooks/useAuth.tsx` - å¢å¼ºè®¤è¯é€»è¾‘
- `supabase/user_table.sql` - æ•°æ®åº“è¡¨ç»“æ„
- `src/services/dataService.ts` - ç”¨æˆ·æœåŠ¡å‡½æ•°

**å·¥ä½œæµç¨‹ï¼š**
```
æ³¨å†Œ â†’ Supabase Auth â†’ è§¦å‘å™¨åˆ›å»ºusersè®°å½• â†’ è®°å½•æ´»åŠ¨æ—¥å¿— âœ“
ç™»å½• â†’ Supabase Auth â†’ éªŒè¯usersè¡¨ â†’ è®°å½•æ—¥å¿— â†’ æˆåŠŸ âœ“
     â†“ (ä¸å­˜åœ¨)
     æ‹’ç»ç™»å½• + æç¤º"ç”¨æˆ·è´¦å·ä¸å­˜åœ¨" âœ“
```

### 2. çœŸå®æ•°æ®å±•ç¤º âœ…

**å®ç°å†…å®¹ï¼š**
- âœ… åˆ›å»ºæ•°æ®æœåŠ¡å±‚ (`dataService.ts`)
- âœ… åˆ›å»º React Query hooks (`useStockData.tsx`)
- âœ… æ›¿æ¢æ‰€æœ‰ mock æ•°æ®
- âœ… è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
- âœ… æ•°æ®ç¼“å­˜ä¼˜åŒ–

**æ•°æ®æ¥å£ï¼š**
- `fetchLimitStocks()` - æ¶¨åœè‚¡ç¥¨åˆ—è¡¨
- `fetchLimitSteps()` - è¿æ¿å¤©æ¢¯
- `fetchTopList()` - é¾™è™æ¦œæ˜ç»†
- `fetchTopInst()` - æœºæ„å¸­ä½
- `fetchSectors()` - æ¿å—æ•°æ®
- `fetchMarketOverview()` - å¸‚åœºæ¦‚è§ˆ

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `src/pages/Index.tsx` - ä¸»é¡µæ•°æ®é›†æˆ
- `src/components/tabs/MarketMoodTab.tsx` - å¸‚åœºæƒ…ç»ªç»„ä»¶
- `src/types/finance.ts` - ç±»å‹å®šä¹‰æ›´æ–°

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰

### æ­¥éª¤ 1: æ‰§è¡Œæ•°æ®åº“è„šæœ¬ âš ï¸ å¿…é¡»å…ˆåš

1. æ‰“å¼€ Supabase æ§åˆ¶å°ï¼š
   ```
   https://supabase.com/dashboard/project/iuwwevhgjzqbnuclkate
   ```

2. ç‚¹å‡»å·¦ä¾§èœå• **SQL Editor** â†’ **New Query**

3. å¤åˆ¶ `supabase/user_table.sql` å…¨éƒ¨å†…å®¹å¹¶æ‰§è¡Œ

4. éªŒè¯è¡¨åˆ›å»ºæˆåŠŸï¼š
   ```sql
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name IN ('users', 'user_activity_logs');
   ```

### æ­¥éª¤ 2: æµ‹è¯•æ•°æ®åº“è¿æ¥

1. åŒå‡»æ‰“å¼€ `test_connection.html`
2. ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®
3. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…

### æ­¥éª¤ 3: å¯åŠ¨ç½‘ç«™

**æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰**
```bash
åŒå‡» start.bat
```

**æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨**
```bash
cd "c:\Users\Lenovo\Documents\Obsidian Vault\AlphaPulse Project\dream-site-builder-main"
npm install  # å¦‚æœæ˜¯é¦–æ¬¡è¿è¡Œ
npm run dev
```

### æ­¥éª¤ 4: æµ‹è¯•åŠŸèƒ½

1. **æµ‹è¯•æ³¨å†Œï¼š**
   - è®¿é—® http://localhost:5173
   - ç‚¹å‡»æ³¨å†Œï¼Œå¡«å†™ä¿¡æ¯
   - âœ… æˆåŠŸåæ£€æŸ¥ Supabase `users` è¡¨æœ‰æ–°è®°å½•

2. **æµ‹è¯•ç™»å½•ï¼š**
   - ä½¿ç”¨æ³¨å†Œçš„è´¦å·ç™»å½•
   - âœ… æˆåŠŸè¿›å…¥ä¸»é¡µ

3. **æµ‹è¯•æ•°æ®å±•ç¤ºï¼š**
   - ä¸»é¡µåº”æ˜¾ç¤ºçœŸå®è‚¡ç¥¨æ•°æ®
   - åˆ‡æ¢æ—¥æœŸï¼Œæ•°æ®è‡ªåŠ¨æ›´æ–°
   - åˆ‡æ¢æ ‡ç­¾é¡µï¼ˆæ‰“æ¿ä¸“é¢˜ã€é¾™è™æ¦œã€æ¿å—é£å£ï¼‰

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
dream-site-builder-main/
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ user_table.sql          # ç”¨æˆ·è¡¨SQLè„šæœ¬ âš ï¸ å¿…é¡»æ‰§è¡Œ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ dataService.ts      # æ•°æ®æœåŠ¡å±‚ï¼ˆæ–°ï¼‰
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAuth.tsx         # è®¤è¯hooksï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”‚   â””â”€â”€ useStockData.tsx    # æ•°æ®hooksï¼ˆæ–°ï¼‰
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ Index.tsx           # ä¸»é¡µï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ tabs/
â”‚   â”‚       â””â”€â”€ MarketMoodTab.tsx  # å¸‚åœºæƒ…ç»ªï¼ˆå·²æ›´æ–°ï¼‰
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ finance.ts          # ç±»å‹å®šä¹‰ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ test_connection.html        # è¿æ¥æµ‹è¯•å·¥å…·
â”œâ”€â”€ start.bat                   # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”œâ”€â”€ DEPLOYMENT_GUIDE.md         # è¯¦ç»†éƒ¨ç½²æ–‡æ¡£
â””â”€â”€ README_COMPLETION.md        # æœ¬æ–‡ä»¶
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®ç¼“å­˜ç­–ç•¥

React Query é…ç½®ï¼š
- **ç¼“å­˜æ—¶é—´**: 5åˆ†é’Ÿï¼ˆstaleTimeï¼‰
- **è‡ªåŠ¨åˆ·æ–°**: 10åˆ†é’Ÿï¼ˆrefetchIntervalï¼‰
- **é”™è¯¯é‡è¯•**: è‡ªåŠ¨é‡è¯•3æ¬¡

### æ•°æ®åº“ç´¢å¼•

å»ºè®®æ·»åŠ çš„ç´¢å¼•ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰ï¼š
```sql
CREATE INDEX idx_limit_list_ths_trade_date ON limit_list_ths(trade_date);
CREATE INDEX idx_top_list_trade_date ON top_list(trade_date);
CREATE INDEX idx_limit_cpt_list_trade_date ON limit_cpt_list(trade_date);
```

### RLS å®‰å…¨ç­–ç•¥

ç”¨æˆ·è¡¨ç­–ç•¥ï¼š
- âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®°å½•
- âœ… ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„è®°å½•
- âœ… æ—¥å¿—è¡¨è®°å½•ä¸å¯ä¿®æ”¹

---

## ğŸ¯ åŠŸèƒ½æ¼”ç¤º

### ç”¨æˆ·è®¤è¯æµç¨‹

```mermaid
graph LR
    A[è®¿é—®ç½‘ç«™] --> B{å·²ç™»å½•?}
    B -->|å¦| C[æ˜¾ç¤ºç™»å½•é¡µ]
    B -->|æ˜¯| D[ä¸»é¡µ]
    C --> E[æ³¨å†Œ]
    C --> F[ç™»å½•]
    E --> G[Supabase Auth]
    F --> H[Supabase Auth]
    G --> I[è§¦å‘å™¨åˆ›å»ºusersè®°å½•]
    H --> J{éªŒè¯usersè¡¨}
    J -->|å­˜åœ¨| D
    J -->|ä¸å­˜åœ¨| K[æ‹’ç»ç™»å½•]
```

### æ•°æ®è·å–æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·åˆ‡æ¢æ—¥æœŸ] --> B[useStockDataBundle]
    B --> C{ç¼“å­˜æœ‰æ•ˆ?}
    C -->|æ˜¯| D[è¿”å›ç¼“å­˜æ•°æ®]
    C -->|å¦| E[è°ƒç”¨dataService]
    E --> F[SupabaseæŸ¥è¯¢]
    F --> G[è¿”å›æ•°æ®]
    G --> H[æ›´æ–°ç¼“å­˜]
    H --> I[æ¸²æŸ“é¡µé¢]
```

---

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### æ¶¨åœæ•°æ®

```json
{
  "ts_code": "000001.SZ",
  "name": "å¹³å®‰é“¶è¡Œ",
  "price": 10.50,
  "pct_chg": 10.02,
  "lu_desc": "é‡‘èæ¿å—å¤§æ¶¨",
  "first_time": "09:30:00",
  "open_times": 0,
  "fd_amount": 50000,
  "status": "å°æ¿"
}
```

### å¸‚åœºæ¦‚è§ˆ

```json
{
  "trade_date": "20250120",
  "limit_up_count": 85,
  "limit_down_count": 3,
  "top_list_count": 42,
  "total_amount": 1250000
}
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: ç™»å½•æç¤º"ç”¨æˆ·è´¦å·ä¸å­˜åœ¨"

**åŸå› ï¼š** ç”¨æˆ·åªåœ¨ `auth.users` ä¸­ï¼Œä¸åœ¨ `public.users` ä¸­

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥æ˜¯å¦æ‰§è¡Œäº† `user_table.sql`
2. éªŒè¯è§¦å‘å™¨æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š
   ```sql
   SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';
   ```
3. æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·è®°å½•ï¼š
   ```sql
   INSERT INTO public.users (id, email, username)
   VALUES ('user-uuid', 'email@example.com', 'username');
   ```

### Q2: æ•°æ®æ˜¾ç¤ºä¸ºç©º

**æ£€æŸ¥æ¸…å•ï¼š**
- âœ… Tushare æ•°æ®å›å¡«æ˜¯å¦å®Œæˆï¼Ÿ
- âœ… æ•°æ®åº“è¡¨ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Ÿ
  ```sql
  SELECT COUNT(*) FROM limit_list_ths;
  ```
- âœ… æµè§ˆå™¨æ§åˆ¶å°æœ‰æ— é”™è¯¯ï¼Ÿ
- âœ… ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸï¼Ÿï¼ˆå¼€å‘è€…å·¥å…· â†’ Networkï¼‰

### Q3: é¡µé¢ä¸€ç›´åŠ è½½ä¸­

**å¯èƒ½åŸå› ï¼š**
1. Supabase API å“åº”æ…¢
2. RLS æƒé™é…ç½®é”™è¯¯
3. æŸ¥è¯¢æ¡ä»¶ä¸åŒ¹é…

**æ’æŸ¥æ­¥éª¤ï¼š**
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const { createClient } = supabaseAuth;
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const { data, error } = await supabase.from('limit_list_ths').select('*').limit(1);
console.log(data, error);
```

### Q4: æ•°æ®ä¸åˆ·æ–°

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ¸…é™¤ React Query ç¼“å­˜ï¼š
   ```javascript
   queryClient.invalidateQueries();
   ```
2. æ£€æŸ¥ `refetchInterval` é…ç½®
3. æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼ˆCtrl + Rï¼‰

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åˆ†é¡µ
```typescript
// ä¸ºå¤§æ•°æ®é‡æ·»åŠ åˆ†é¡µ
const { data } = await supabase
  .from('limit_list_ths')
  .select('*')
  .range(0, 99)  // ç¬¬1-100æ¡
  .order('trade_date', { ascending: false });
```

### 2. é€‰æ‹©æ€§å­—æ®µ
```typescript
// åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
const { data } = await supabase
  .from('limit_list_ths')
  .select('ts_code, name, price, pct_chg')
  .limit(50);
```

### 3. æ·»åŠ ç´¢å¼•
```sql
-- å¤åˆç´¢å¼•æå‡æŸ¥è¯¢é€Ÿåº¦
CREATE INDEX idx_limit_ths_date_pct ON limit_list_ths(trade_date, pct_chg DESC);
```

---

## ğŸ“ˆ åç»­æ‰©å±•åŠŸèƒ½

### çŸ­æœŸç›®æ ‡
- [ ] è‡ªé€‰è‚¡æ”¶è—åŠŸèƒ½
- [ ] ä»·æ ¼æé†’æ¨é€
- [ ] Kçº¿å›¾å¯è§†åŒ–
- [ ] ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ–

### ä¸­æœŸç›®æ ‡
- [ ] å®æ—¶æ•°æ®æ¨é€ï¼ˆWebSocketï¼‰
- [ ] å†å²æ•°æ®å›æµ‹
- [ ] ä¸ªè‚¡è¯¦æƒ…é¡µ
- [ ] æ¿å—çƒ­åº¦åˆ†æ

### é•¿æœŸç›®æ ‡
- [ ] AI æ™ºèƒ½é€‰è‚¡
- [ ] ç­–ç•¥å›æµ‹ç³»ç»Ÿ
- [ ] ç¤¾åŒºäº¤æµåŠŸèƒ½
- [ ] ç§»åŠ¨ App

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æŸ¥çœ‹æ—¥å¿—

**å‰ç«¯æ—¥å¿—ï¼š**
```
æµè§ˆå™¨ â†’ F12 â†’ Console
```

**åç«¯æ—¥å¿—ï¼š**
```
Supabase æ§åˆ¶å° â†’ Logs â†’ Edge Functions
```

### æ•°æ®åº“ç®¡ç†

**æŸ¥çœ‹æ‰€æœ‰è¡¨ï¼š**
```sql
SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
```

**æŸ¥çœ‹è¡¨ç»“æ„ï¼š**
```sql
SELECT column_name, data_type FROM information_schema.columns 
WHERE table_name = 'users';
```

**æŸ¥çœ‹RLSç­–ç•¥ï¼š**
```sql
SELECT * FROM pg_policies WHERE tablename = 'users';
```

---

## âœ… éªŒæ”¶æ¸…å•

è¯·ç¡®è®¤ä»¥ä¸‹æ‰€æœ‰é¡¹ç›®ï¼š

### æ•°æ®åº“
- [ ] `user_table.sql` å·²æ‰§è¡Œ
- [ ] `users` è¡¨å­˜åœ¨
- [ ] `user_activity_logs` è¡¨å­˜åœ¨
- [ ] è§¦å‘å™¨ `on_auth_user_created` å·²åˆ›å»º
- [ ] RLS ç­–ç•¥å·²å¯ç”¨

### ç”¨æˆ·è®¤è¯
- [ ] æ³¨å†ŒåŠŸèƒ½æ­£å¸¸
- [ ] ç™»å½•éªŒè¯æ•°æ®åº“
- [ ] ä¸å­˜åœ¨çš„ç”¨æˆ·è¢«æ‹’ç»
- [ ] æ´»åŠ¨æ—¥å¿—æ­£å¸¸è®°å½•

### æ•°æ®å±•ç¤º
- [ ] ä¸»é¡µæ˜¾ç¤ºçœŸå®æ•°æ®
- [ ] æ¶¨åœåˆ—è¡¨æ­£å¸¸
- [ ] é¾™è™æ¦œæ­£å¸¸
- [ ] æ¿å—æ•°æ®æ­£å¸¸
- [ ] æ—¥æœŸåˆ‡æ¢æ­£å¸¸
- [ ] åŠ è½½çŠ¶æ€æ˜¾ç¤º
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®

### æ€§èƒ½
- [ ] æ•°æ®ç¼“å­˜ç”Ÿæ•ˆ
- [ ] è‡ªåŠ¨åˆ·æ–°å·¥ä½œ
- [ ] é¡µé¢åŠ è½½é€Ÿåº¦ < 3ç§’

---

## ğŸ‰ æ€»ç»“

### å®Œæˆå†…å®¹
âœ… ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ˆæ•°æ®åº“éªŒè¯ï¼‰
âœ… çœŸå®æ•°æ®å±•ç¤ºï¼ˆæ›¿æ¢mockæ•°æ®ï¼‰
âœ… æ•°æ®æœåŠ¡å±‚æ¶æ„
âœ… React Query é›†æˆ
âœ… é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
âœ… è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
âœ… å®Œæ•´éƒ¨ç½²æ–‡æ¡£

### æŠ€æœ¯äº®ç‚¹
- ğŸ” å®‰å…¨çš„ç”¨æˆ·è®¤è¯æµç¨‹
- ğŸ“Š å®æ—¶æ•°æ®å±•ç¤º
- âš¡ æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- ğŸ¨ ä¼˜é›…çš„åŠ è½½çŠ¶æ€
- ğŸ›¡ï¸ RLS è¡Œçº§å®‰å…¨

### ä»£ç è´¨é‡
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… React æœ€ä½³å®è·µ
- âœ… æ¨¡å—åŒ–æ¶æ„
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… ä»£ç æ³¨é‡Šæ¸…æ™°

---

**å¼€å‘å®Œæˆæ—¶é—´ï¼š** 2025-01-20  
**æŠ€æœ¯æ ˆï¼š** React 18 + TypeScript + Supabase + TanStack Query + Shadcn UI  
**æ•°æ®åº“ï¼š** PostgreSQL (Supabase)  
**çŠ¶æ€ï¼š** âœ… å¼€å‘å®Œæˆï¼Œå¾…éƒ¨ç½²æµ‹è¯•
